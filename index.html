<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>雞蛋糕的多重宇宙｜GCAKE.Space</title>
  <style id="themeStyles"></style>
  <style>
    /* ... CSS 內容同原始，略 ... */
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <img src="img/GCAKE.png" alt="GCAKE Logo">
      <strong>GCAKE.Space</strong>
    </div>
    <nav>
      <a href="#home">Home</a>
      <a href="#podcast">Podcast</a>
      <a href="#podcast2">Podcast2</a>
      <a href="#newsletter">Newsletter</a>
      <a href="#newsletter2">Newsletter2</a>
      <a href="#works">Works</a>
      <a href="#about">About</a>
      <a href="#contact">Contact</a>
    </nav>
  </header>
  
  <main id="app"></main>
  <footer>
    <p>© 2025 GCAKE.Space</p>
  </footer>
  
  <script>
    // Gruvbox 主題同原始
    const gruvboxAccessible = `
      body { background:#282828; color:#ebdbb2; }
      header { background:#3c3836; border-bottom:1px solid #665c54; }
      nav a { color:#facc15; }
      nav a:hover { color:#38bdf8; }
      .card { background:#32302f; border:1px solid #665c54; }
      .card h3 { color:#facc15; }
      .meta { color:#a89984; }
      a { color:#38bdf8; }
      a:hover { color:#ec4899; }
      iframe.podcast-player { background:#000; }
      footer { background:#3c3836; color:#a89984; }
      .badge { border-color:#a89984; color:#a89984; }
    `;
    document.getElementById("themeStyles").textContent = gruvboxAccessible;

    // ========= base path 計算 =========
    function getBasePath() {
      // index.html 在根目錄: /rss-to-json/index.html => "/rss-to-json/"
      // index.html 在本地根目錄 => "/"
      // index.html 在 /ipfs/Qm.../ => "/ipfs/Qm.../"
      let path = window.location.pathname;
      if(path.endsWith('.html')) path = path.replace(/index\.html$/, '');
      if(!path.endsWith('/')) path += '/';
      return path;
    }
    const BASE = getBasePath();

    // ========= 工具（同原始） =========
    const fmtDate = iso => { try { const d = new Date(iso); return d.toISOString().slice(0,16).replace('T',' '); } catch { return iso || ''; }};
    const htmlEscape = (s='') => (s||'').replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    async function loadJSON(url) {
      const res = await fetch(url, { cache:'no-cache' });
      if (!res.ok) throw new Error(`Load failed ${res.status} ${res.statusText} for ${url}`);
      return res.json();
    }
    function pager(totalPages, baseHash, current=1) {
      let html = `<div class="pager">`;
      for(let p=1; p<=totalPages; p++) {
        const cls = p === current ? 'current' : '';
        html += `<a class="${cls}" href="${baseHash}?p=${p}">第${p}頁</a>`;
      }
      html += `</div>`;
      return html;
    }
    function params() {
      const h = location.hash.split('?');
      const qs = new URLSearchParams(h[1] || '');
      return Object.fromEntries(qs.entries());
    }
    function firstoryEmbedFromPermalink(permalink) {
      if (typeof permalink !== "string") return null;
      if (permalink.startsWith("https://open.firstory.me/story/")) {
        return permalink.replace("/story/", "/embed/story/");
      }
      return null;
    }
    function cleanContentHtml(html, coverUrl) {
      const wrapper = document.createElement('div');
      wrapper.innerHTML = html;
      for (const img of wrapper.querySelectorAll('img')) {
        if (coverUrl && img.src === coverUrl) {
          img.remove();
          continue;
        }
        img.classList.add('newsletter-img'); img.setAttribute('loading', 'lazy');
      }
      for (const sel of [
        '.captioned-image-container', '.button', '.subscribe-button', '.share',
        '.sharing', '.newsletter-toolbar','[data-testid="SubscriptionButton"]','form','iframe','svg','.icon','.subscription-widget'
      ]) for (const el of wrapper.querySelectorAll(sel)) el.remove();
      for (const el of wrapper.querySelectorAll('a,button')) {
        const isBlock = (el.tagName === 'BUTTON') || window.getComputedStyle(el).display === 'block' || el.className.match(/button|subscribe|share|icon/i);
        if (isBlock && el.textContent.match(/訂閱|subscribe|分享|share/i)) el.remove();
      }
      return wrapper.innerHTML;
    }

    // ========= Podcast 列表頁 =========
    async function renderPodcastList(rootDir, baseHash) {
      const p = parseInt(params().p || '1', 10);
      const idxUrl = `${BASE}${rootDir}/index-p${p}.json`;
      let idx;
      try { idx = await loadJSON(idxUrl); }
      catch(e) { if (p !== 1) return renderPodcastList(rootDir, baseHash.replace(/\?p=\d+$/, '')); throw e; }
      let html = `<div class="card"><p class="meta">共 ${idx.total_items} 篇 · 分頁 ${p}/${idx.total_pages}</p></div>`;
      for(const it of idx.items) {
        html += `
          <div class="card" style="cursor:pointer;" 
               onclick="location.hash='#viewPodcast?dir=${encodeURIComponent(rootDir)}&slug=${encodeURIComponent(it.slug)}'">
            <div style="display:flex;align-items:center;">
              ${(it.image || idx.show.image) ? 
                `<img src="${it.image || idx.show.image}" alt="" style="width:80px;height:80px;border-radius:8px;object-fit:cover;margin-right:1rem;">` : ''}
              <div>
                <h3 style="margin:0.2rem 0;">${htmlEscape(it.title || '')}</h3>
                <div class="meta">
                  ${fmtDate(it.pub_date || '')} 
                  ${it.duration ? `｜${it.duration}` : ''}
                  ${it.season ? `｜S${it.season}` : ''}
                  ${it.episode ? `E${it.episode}` : ''}
                </div>
              </div>
            </div>
          </div>
        `;
      }
      html += pager(idx.total_pages||1, baseHash, p);
      return html;
    }

    // ========= Podcast 單集詳情 =========
    async function renderPodcastDetail(dir, slug) {
      const tryPages = [1,2,3,4,5];
      let itemMeta = null;
      for(const p of tryPages) {
        try {
          const idx = await loadJSON(`${BASE}${dir}/index-p${p}.json`);
          itemMeta = (idx.items||[]).find(x=>x.slug===slug);
          if(itemMeta) break;
        } catch{}
      }
      if(!itemMeta) return `<div class="card"><p>找不到單集（slug=${htmlEscape(slug)}）。</p></div>`;
      const file = `${BASE}${dir}/${slug}.json`;
      let art;
      try { art = await loadJSON(file); }
      catch {
        return `<div class="card">
          <h3>${htmlEscape(itemMeta.title||'')}</h3>
          <p>無法載入本地單集資料。</p>
          ${itemMeta.link ? `<p><a href="${itemMeta.link}" target="_blank" rel="noopener">前往原文</a></p>` : ''}
        </div>`;
      }
      const embed = firstoryEmbedFromPermalink(art.permalink||art.link);
      return `
        <div class="card">
          <h2>${htmlEscape(art.title||'')}</h2>
          <div class="meta">
            ${fmtDate(art.pub_date||'')} 
            ${art.duration ? `｜${art.duration}`: ''}
            ${art.season?`｜Season ${art.season}`:''}
            ${art.episode?`｜Ep${art.episode}`:''}
          </div>
          ${art.cover ? `<img class="cover" src="${art.cover}" alt="">` : ''}
          ${embed ? `<iframe class="podcast-player" src="${embed}" allow="autoplay"></iframe>` : ''}
          ${art.audio ? `<p><a href="${art.audio}" target="_blank" rel="noopener">下載音檔</a></p>` : ''}
          <div style="margin-top:0.8em;">${art.description_html||htmlEscape(art.description_text||'')}</div>
          ${art.link ? `<p><a href="${art.link}" target="_blank" rel="noopener">原文連結</a></p>` : ''}
          <div class="pager"><a href="javascript:history.back()">← 返回列表</a></div>
        </div>
      `;
    }

    // ========= Newsletter 列表 =========
    async function renderNewsletterList(rootDir, baseHash) {
      const p = parseInt(params().p || '1', 10);
      const idxUrl = `${BASE}${rootDir}/index-p${p}.json`;
      let idx;
      try { idx = await loadJSON(idxUrl); }
      catch(e) { if (p !== 1) return renderNewsletterList(rootDir, baseHash.replace(/\?p=\d+$/, '')); throw e; }
      let html = `<div class="card"><p class="meta">共 ${idx.total_items} 篇 · 分頁 ${p}/${idx.total_pages}</p></div>`;
      for(const it of idx.items) {
        html += `
          <div class="card" style="cursor:pointer;" 
               onclick="location.hash='#viewNewsletter?dir=${encodeURIComponent(rootDir)}&slug=${encodeURIComponent(it.slug)}'">
            <div style="display:flex;align-items:center;">
              ${it.cover ? 
                `<img src="${it.cover}" alt="" style="width:80px;height:80px;border-radius:8px;object-fit:cover;margin-right:1rem;">`
                : ''}
              <div style="flex:1;">
                <h3 style="margin:0.2rem 0;">
                  ${htmlEscape(it.title||'')}
                  ${it.has_voiceover ? `<span class="badge">voiceover</span>` : ''}
                </h3>
                <div class="meta">${fmtDate(it.pub_date||'')}</div>
                ${it.summary ? `<p style="margin:0.3rem 0; color:#a89984; font-size:0.9em;">${htmlEscape(it.summary)}</p>` : ''}
              </div>
            </div>
          </div>
        `;
      }
      html += pager(idx.total_pages||1, baseHash, p);
      return html;
    }

    // ========= Newsletter 詳細 =========
    async function renderNewsletterDetail(dir, slug) {
      const tryPages = [1,2,3,4,5];
      let itemMeta = null;
      for(const p of tryPages){
        try{
          const idx = await loadJSON(`${BASE}${dir}/index-p${p}.json`);
          itemMeta = (idx.items||[]).find(x=>x.slug===slug);
          if(itemMeta) break;
        }catch{}
      }
      if(!itemMeta) return `<div class="card"><p>找不到文章（slug=${htmlEscape(slug)}）。</p></div>`;
      const d = new Date(itemMeta.pub_date||Date.now());
      const yyyy = d.getUTCFullYear();
      const mm = String(d.getUTCMonth()+1).padStart(2,'0');
      const dd = String(d.getUTCDate()).padStart(2,'0');
      const file = `${BASE}${dir}/${yyyy}-${mm}-${dd}_${slug}.json`;
      let art;
      try { art = await loadJSON(file); }
      catch {
        return `<div class="card">
          <h3>${htmlEscape(itemMeta.title||'')}</h3>
          <p>無法載入本地文章。</p>
        </div>`;
      }
      const tags = Array.isArray(art.tags) && art.tags.length ? `<p class="meta"># ${art.tags.map(htmlEscape).join(' · ')}</p>` : '';
      return `
        <div class="card">
          <h2>${htmlEscape(art.title||'')}</h2>
          <div class="meta">${fmtDate(art.pub_date||'')}</div>
          ${tags}
          ${art.cover ? `<img class="cover" src="${art.cover}" alt="">` : ''}
          ${art.voiceover?.url ? `<p><a href="${art.voiceover.url}" target="_blank" rel="noopener">🎵 Voiceover 音訊</a></p>` : ''}
          <div class="newsletter-content" style="margin-top:0.8em;">
            ${art.content_html ? cleanContentHtml(art.content_html, art.cover) : `<p>${htmlEscape(art.content_text||'')}</p>`}
          </div>
          <div class="pager"><a href="javascript:history.back()">← 返回列表</a></div>
        </div>
      `;
    }

    // ========== SPA 路由 ==========
    async function pagePodcast1() {
      const head = `<h1>Podcast｜《喂喂你還好不好》</h1> ...`;
      const list = await renderPodcastList('data/podcast/podcast_1', '#podcast');
      return head + list;
    }
    async function pagePodcast2() {
      const head = `<h1>Podcast｜《雞蛋糕孵蛋中》</h1> ...`;
      const list = await renderPodcastList('data/podcast/podcast_2', '#podcast2');
      return head + list;
    }
    async function pageNewsletter1() {
      const head = `<h1>Newsletter｜《喂喂你還好不好》</h1> ...`;
      const list = await renderNewsletterList('data/newsletter/newsletter_1', '#newsletter');
      return head + list;
    }
    async function pageNewsletter2() {
      const head = `<h1>Newsletter｜《區塊鏈文摘》</h1> ...`;
      const list = await renderNewsletterList('data/newsletter/newsletter_2', '#newsletter2');
      return head + list;
    }

    // ... staticPages 不變

    // SPA hash/router
    async function render() {
      const [routePart] = location.hash.replace('#','').split('?');
      const hash = routePart || 'home';
      const app = document.getElementById('app');
      try {
        if (hash === 'podcast') {
          app.innerHTML = await pagePodcast1();
        } else if (hash === 'podcast2') {
          app.innerHTML = await pagePodcast2();
        } else if (hash === 'newsletter') {
          app.innerHTML = await pageNewsletter1();
        } else if (hash === 'newsletter2') {
          app.innerHTML = await pageNewsletter2();
        } else if (hash === 'viewPodcast') {
          const q = params();
          if (!q.dir || !q.slug) app.innerHTML = `<div class="card"><p>缺少參數。</p></div>`;
          else app.innerHTML = await renderPodcastDetail(q.dir, q.slug);
        } else if (hash === 'viewNewsletter') {
          const q = params();
          if (!q.dir || !q.slug) app.innerHTML = `<div class="card"><p>缺少參數。</p></div>`;
          else app.innerHTML = await renderNewsletterDetail(q.dir, q.slug);
        } else {
          app.innerHTML = staticPages[hash] || staticPages.home;
        }
      } catch (e) {
        console.error('渲染錯誤:', e);
        app.innerHTML = `<div class="card"><p>載入失敗：${htmlEscape(String(e.message || e))}</p></div>`;
      }
    }
    window.addEventListener('hashchange', render);
    render();

  </script>
</body>
</html>
