<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>雞蛋糕的多重宇宙｜GCAKE.Space</title>
  <style id="themeStyles"></style>
  <style>
    /* ========== 基礎版面與字型 ========== */
    body { 
      margin:0; 
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; 
    }
    
    /* ========== Header 導覽列 ========== */
    header { 
      padding:1rem 2rem; 
      border-bottom:1px solid #333; 
      display:flex; 
      justify-content:space-between; 
      align-items:center; 
    }
    header .logo { display:flex; align-items:center; }
    header .logo img { height:40px; margin-right:0.5rem; }
    nav a { margin-left:1rem; text-decoration:none; }
    nav a:hover { text-decoration:underline; }
    
    /* ========== 主要內容區域 ========== */
    main { padding:2rem; max-width:960px; margin:auto; }
    
    /* ========== 卡片元件 ========== */
    .card { 
      border-radius:12px; 
      padding:1rem; 
      margin-bottom:1rem; 
      transition: all 0.2s ease;
    }
    .card h3 { margin:0.2rem 0 0.4rem; }
    .card:hover { transform: translateY(-2px); }
    
    /* ========== 文字與標籤樣式 ========== */
    .meta { font-size:0.9em; margin:0.2em 0 0.6em; }
    .cover { width:100%; border-radius:8px; margin:0.5rem 0; }
    .badge { 
      display:inline-block; 
      font-size:0.75em; 
      padding:0.15em 0.5em; 
      border-radius:999px; 
      border:1px solid #888; 
      margin-left:0.5rem; 
    }
    
    /* ========== 分頁與操作按鈕 ========== */
    .pager { margin:1rem 0; }
    .pager a { text-decoration:none; margin-right:0.5rem; }
    .pager a.current { text-decoration:underline; }
    
    /* ========== Podcast 播放器 ========== */
    iframe.podcast-player { 
      width:100%; 
      height:180px; 
      border:0; 
      border-radius:10px; 
      overflow:hidden; 
      margin:0.5rem 0;
    }
    
    /* ========== 頁面底部 ========== */
    footer { text-align:center; padding:1rem; border-top:1px solid #333; }
    
    /* ========== 其他元件 ========== */
    ul { margin:0.5em 0 0.5em 1em; }
    .avatar { width:120px; border-radius:50%; margin-bottom:1rem; }
    .grid { display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
    
    /* ========== RWD 響應式設計 ========== */
    @media (max-width: 800px) {
      .grid { grid-template-columns:1fr; }
      header { padding:0.8rem 1rem; }
      main { padding:1rem; }
    }
    
    /* ========== 按鈕樣式 ========== */
    button { 
      background:transparent; 
      color:#38bdf8; 
      border:1px solid #665c54; 
      border-radius:8px; 
      padding:0.25rem 0.6rem; 
      cursor:pointer; 
    }
    button:hover { border-color:#a89984; }
    
    /* =========== 電子報全文排版 ============ */
    .newsletter-detail .newsletter-cover {
        width: 100%;
        max-height: 400px;
        object-fit: cover;
        margin-bottom: 1.5em;
        border-radius: 12px;
        box-shadow: 0 2px 16px rgba(0,0,0,0.03);
    }
    .newsletter-content img.newsletter-img {
        display: block;
        margin: 1.5em auto;
        max-width: 92%;
        max-height: 420px;
        border-radius: 8px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.06);
        object-fit: contain;
    }
    .newsletter-content {
        line-height: 1.8;
        font-size: 1.07em;
        letter-spacing: 0.01em;
        word-break: break-word;
    }

  </style>
</head>
<body>
  <!-- ========== 網站 Header 導覽列 ========== -->
  <header>
    <div class="logo">
      <img src="img/GCAKE.png" alt="GCAKE Logo">
      <strong>GCAKE.Space</strong>
    </div>
    <nav>
      <a href="#home">Home</a>
      <a href="#podcast">Podcast</a>
      <a href="#podcast2">Podcast2</a>
      <a href="#newsletter">Newsletter</a>
      <a href="#newsletter2">Newsletter2</a>
      <a href="#works">Works</a>
      <a href="#about">About</a>
      <a href="#contact">Contact</a>
    </nav>
  </header>
  
  <!-- ========== 主要內容顯示區域 ========== -->
  <main id="app"></main>
  
  <!-- ========== 網站底部資訊 ========== -->
  <footer>
    <p>© 2025 GCAKE.Space</p>
  </footer>
  
  <script>
    /* ========================================
     * 主題樣式設定
     * ======================================== */
    // Gruvbox Dark 色弱友善版主題
    const gruvboxAccessible = `
      body { background:#282828; color:#ebdbb2; }
      header { background:#3c3836; border-bottom:1px solid #665c54; }
      nav a { color:#facc15; }
      nav a:hover { color:#38bdf8; }
      .card { background:#32302f; border:1px solid #665c54; }
      .card h3 { color:#facc15; }
      .meta { color:#a89984; }
      a { color:#38bdf8; }
      a:hover { color:#ec4899; }
      iframe.podcast-player { background:#000; }
      footer { background:#3c3836; color:#a89984; }
      .badge { border-color:#a89984; color:#a89984; }
    `;
    document.getElementById("themeStyles").textContent = gruvboxAccessible;

    /* ========================================
     * 工具函式
     * ======================================== */
    
    // 格式化日期時間
    const fmtDate = iso => {
      try { 
        const d = new Date(iso); 
        return d.toISOString().slice(0,16).replace('T',' '); 
      }
      catch { return iso || ''; }
    };
    
    // HTML 字符轉義防止 XSS
    const htmlEscape = (s='') => (s||'').replace(/[&<>"]/g, c=>({ 
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' 
    }[c]));
    
    // 載入 JSON 檔案
    async function loadJSON(url) {
      const res = await fetch(url, { cache:'no-cache' });
      if (!res.ok) throw new Error(`Load failed ${res.status} ${res.statusText} for ${url}`);
      return res.json();
    }
    
    // 產生分頁器
    function pager(totalPages, baseHash, current=1) {
      let html = `<div class="pager">`;
      for(let p=1; p<=totalPages; p++) {
        const cls = p === current ? 'current' : '';
        html += `<a class="${cls}" href="${baseHash}?p=${p}">第${p}頁</a>`;
      }
      html += `</div>`;
      return html;
    }
    
    // 解析 URL 參數
    function params() {
      const h = location.hash.split('?');
      const qs = new URLSearchParams(h[1] || '');
      return Object.fromEntries(qs.entries());
    }
    
    // 將 Firstory permalink 轉換為內嵌播放器 URL
    function firstoryEmbedFromPermalink(permalink) {
      if (typeof permalink !== "string") return null;
      if (permalink.startsWith("https://open.firstory.me/story/")) {
        return permalink.replace("/story/", "/embed/story/");
      }
      return null;
    }
    
    // 處理 substack 文章插圖和排版
    function cleanContentHtml(html, coverUrl) {
  const wrapper = document.createElement('div');
  wrapper.innerHTML = html;

  // Remove cover images
  for (const img of wrapper.querySelectorAll('img')) {
    if (coverUrl && img.src === coverUrl) {
      img.remove();
      continue;
    }
    img.classList.add('newsletter-img');
    img.setAttribute('loading', 'lazy');
  }

  // Remove block elements for subscribe/share/buttons/toolbar, keep plain links
  for (const sel of [
    '.captioned-image-container',
    '.button',
    '.subscribe-button',
    '.share',
    '.sharing',
    '.newsletter-toolbar',
    '[data-testid="SubscriptionButton"]',
    'form',
    'iframe',
    'svg',
    '.icon',
    '.subscription-widget'
  ]) {
    for (const el of wrapper.querySelectorAll(sel)) {
      el.remove();
    }
  }

  // Optionally: Remove visually obvious buttons (styled as button or with 'Subscribe')
  for (const el of wrapper.querySelectorAll('a,button')) {
    // Only remove if styled as/not a plain text link (e.g. role button, big subscribe/share in block context)
    const isBlock = (
      el.tagName === 'BUTTON' ||
      window.getComputedStyle(el).display === 'block' ||
      el.className.match(/button|subscribe|share|icon/i)
    );
    if (isBlock && el.textContent.match(/訂閱|subscribe|分享|share/i)) {
      el.remove();
    }
  }

  // DO NOT remove <a> elements just based on substack.com href!
  // (So plain links to Substack profiles、文中資料超連結都會正常保留)

  return wrapper.innerHTML;
}



    /* ========================================
     * Podcast 相關渲染函式
     * ======================================== */
    
    // 渲染 Podcast 列表頁面
    async function renderPodcastList(rootDir, baseHash) {
      const p = parseInt(params().p || '1', 10);
      const idxUrl = `${rootDir}/index-p${p}.json`;
      let idx;
      
      // 載入分頁索引檔案
      try { 
        idx = await loadJSON(idxUrl); 
      } catch(e) { 
        // 如果不是第一頁且載入失敗，回到第一頁
        if (p !== 1) return renderPodcastList(rootDir, baseHash.replace(/\?p=\d+$/, '')); 
        throw e; 
      }
      
      // 產生列表 HTML
      let html = `<div class="card"><p class="meta">共 ${idx.total_items} 篇 · 分頁 ${p}/${idx.total_pages}</p></div>`;
      
      for(const it of idx.items) {
        html += `
          <div class="card" style="cursor:pointer;" 
               onclick="location.hash='#viewPodcast?dir=${encodeURIComponent(rootDir)}&slug=${encodeURIComponent(it.slug)}'">
            <div style="display:flex;align-items:center;">
              ${(it.image || idx.show.image) ? 
                `<img src="${it.image || idx.show.image}" alt="" style="width:80px;height:80px;border-radius:8px;object-fit:cover;margin-right:1rem;">` 
                : ''}
              <div>
                <h3 style="margin:0.2rem 0;">${htmlEscape(it.title || '')}</h3>
                <div class="meta">
                  ${fmtDate(it.pub_date || '')} 
                  ${it.duration ? `｜${it.duration}` : ''}
                  ${it.season ? `｜S${it.season}` : ''}
                  ${it.episode ? `E${it.episode}` : ''}
                </div>
              </div>
            </div>
          </div>
        `;
      }
      
      html += pager(idx.total_pages||1, baseHash, p);
      return html;
    }
    
    // 渲染 Podcast 單集詳情頁面
    async function renderPodcastDetail(dir, slug) {
      const tryPages = [1,2,3,4,5];
      let itemMeta = null;
      
      // 在多個分頁中尋找對應的單集資料
      for(const p of tryPages) {
        try {
          const idx = await loadJSON(`${dir}/index-p${p}.json`);
          itemMeta = (idx.items||[]).find(x=>x.slug===slug);
          if(itemMeta) break;
        } catch{}
      }
      
      if(!itemMeta) {
        return `<div class="card"><p>找不到單集（slug=${htmlEscape(slug)}）。</p></div>`;
      }
      
      // 組合單集檔案路徑
      const d = new Date(itemMeta.pub_date||Date.now());
      const yyyy = d.getUTCFullYear();
      const mm = String(d.getUTCMonth()+1).padStart(2,'0');
      const dd = String(d.getUTCDate()).padStart(2,'0');
      const file = `${dir}/${slug}.json`;
      
      // 載入單集詳細資料
      let art;
      try { 
        art = await loadJSON(file); 
      } catch { 
        return `<div class="card">
          <h3>${htmlEscape(itemMeta.title||'')}</h3>
          <p>無法載入本地單集資料。</p>
          ${itemMeta.link ? `<p><a href="${itemMeta.link}" target="_blank" rel="noopener">前往原文</a></p>` : ''}
        </div>`; 
      }
      
      // 產生 Firstory 內嵌播放器
      const embed = firstoryEmbedFromPermalink(art.permalink||art.link);
      
      return `
        <div class="card">
          <h2>${htmlEscape(art.title||'')}</h2>
          <div class="meta">
            ${fmtDate(art.pub_date||'')} 
            ${art.duration ? `｜${art.duration}`: ''}
            ${art.season?`｜Season ${art.season}`:''}
            ${art.episode?`｜Ep${art.episode}`:''}
          </div>
          ${art.cover ? `<img class="cover" src="${art.cover}" alt="">` : ''}
          ${embed ? `<iframe class="podcast-player" src="${embed}" allow="autoplay"></iframe>` : ''}
          ${art.audio ? `<p><a href="${art.audio}" target="_blank" rel="noopener">下載音檔</a></p>` : ''}
          <div style="margin-top:0.8em;">
            ${art.description_html||htmlEscape(art.description_text||'')}
          </div>
          ${art.link ? `<p><a href="${art.link}" target="_blank" rel="noopener">原文連結</a></p>` : ''}
          <div class="pager">
            <a href="javascript:history.back()">← 返回列表</a>
          </div>
        </div>
      `;
    }

    /* ========================================
     * Newsletter 相關渲染函式
     * ======================================== */
    
    // 渲染 Newsletter 列表頁面
    async function renderNewsletterList(rootDir, baseHash) {
      const p = parseInt(params().p || '1', 10);
      const idxUrl = `${rootDir}/index-p${p}.json`;
      let idx;
      
      // 載入分頁索引檔案
      try { 
        idx = await loadJSON(idxUrl); 
      } catch(e) { 
        // 如果不是第一頁且載入失敗，回到第一頁
        if (p !== 1) return renderNewsletterList(rootDir, baseHash.replace(/\?p=\d+$/, '')); 
        throw e; 
      }
      
      // 產生列表 HTML
      let html = `<div class="card"><p class="meta">共 ${idx.total_items} 篇 · 分頁 ${p}/${idx.total_pages}</p></div>`;
      
      for(const it of idx.items) {
        html += `
          <div class="card" style="cursor:pointer;" 
               onclick="location.hash='#viewNewsletter?dir=${encodeURIComponent(rootDir)}&slug=${encodeURIComponent(it.slug)}'">
            <div style="display:flex;align-items:center;">
              ${it.cover ? 
                `<img src="${it.cover}" alt="" 
                     style="width:80px;height:80px;border-radius:8px;object-fit:cover;margin-right:1rem;">` 
                : ''}
              <div style="flex:1;">
                <h3 style="margin:0.2rem 0;">
                  ${htmlEscape(it.title||'')}
                  ${it.has_voiceover ? `<span class="badge">voiceover</span>` : ''}
                </h3>
                <div class="meta">${fmtDate(it.pub_date||'')}</div>
                ${it.summary ? `<p style="margin:0.3rem 0; color:#a89984; font-size:0.9em;">${htmlEscape(it.summary)}</p>` : ''}
              </div>
            </div>
          </div>
        `;
      }
      
      html += pager(idx.total_pages||1, baseHash, p);
      return html;
    }
    
    // 渲染 Newsletter 單篇詳情頁面
    async function renderNewsletterDetail(dir, slug) {
  const tryPages = [1,2,3,4,5];
  let itemMeta = null;
  for(const p of tryPages){
    try{
      const idx = await loadJSON(`${dir}/index-p${p}.json`);
      itemMeta = (idx.items||[]).find(x=>x.slug===slug);
      if(itemMeta) break;
    }catch{}
  }
  if(!itemMeta) {
    return `<div class="card"><p>找不到文章（slug=${htmlEscape(slug)}）。</p></div>`;
  }
  const d = new Date(itemMeta.pub_date||Date.now());
  const yyyy = d.getUTCFullYear();
  const mm = String(d.getUTCMonth()+1).padStart(2,'0');
  const dd = String(d.getUTCDate()).padStart(2,'0');
  const file = `${dir}/${yyyy}-${mm}-${dd}_${slug}.json`;
  let art;
  try{ 
    art = await loadJSON(file);
  } catch{
    return `<div class="card">
      <h3>${htmlEscape(itemMeta.title||'')}</h3>
      <p>無法載入本地文章。</p>
    </div>`;
  }
  const tags = Array.isArray(art.tags) && art.tags.length ? 
    `<p class="meta"># ${art.tags.map(htmlEscape).join(' · ')}</p>` : '';
  return `
    <div class="card">
      <h2>${htmlEscape(art.title||'')}</h2>
      <div class="meta">${fmtDate(art.pub_date||'')}</div>
      ${tags}
      ${art.cover ? `<img class="cover" src="${art.cover}" alt="">` : ''}
      ${art.voiceover?.url ? `<p><a href="${art.voiceover.url}" target="_blank" rel="noopener">🎵 Voiceover 音訊</a></p>` : ''}
      <div class="newsletter-content" style="margin-top:0.8em;">
        ${
            art.content_html
                ? cleanContentHtml(art.content_html, art.cover)
                : `<p>${htmlEscape(art.content_text||'')}</p>`
        }
      </div>
      <div class="pager">
        <a href="javascript:history.back()">← 返回列表</a>
      </div>
    </div>
  `;
}

    /* ========================================
     * 頁面組件函式
     * ======================================== */
    
    // Podcast 第一檔節目頁面
    async function pagePodcast1() {
      const head = `
        <h1>Podcast｜《喂喂你還好不好》</h1>
        <div class="card">
          <p>談精神健康、康復與支持網絡的真實分享。</p>
          <p><a href="https://open.firstory.me/join/wwhowbuhow" target="_blank" rel="noopener">支持與贊助</a></p>
        </div>
      `;
      const list = await renderPodcastList('/data/podcast/podcast_1', '#podcast');
      return head + list;
    }
    
    // Podcast 第二檔節目頁面
    async function pagePodcast2() {
      const head = `
        <h1>Podcast｜《雞蛋糕孵蛋中》</h1>
        <div class="card">
          <p>第二檔節目，主題延伸與創作實驗。</p>
          <p><a href="https://open.firstory.me/join/wwhowbuhow" target="_blank" rel="noopener">支持與贊助</a></p>
        </div>
      `;
      const list = await renderPodcastList('/data/podcast/podcast_2', '#podcast2');
      return head + list;
    }
    
    // Newsletter 第一份電子報頁面
    async function pageNewsletter1() {
      const head = `
        <h1>Newsletter｜《喂喂你還好不好》</h1>
        <div class="card">
          <ul>
            <li>Firstory：<a href="https://open.firstory.me/join/wwhowbuhow" target="_blank" rel="noopener">連結</a></li>
            <li>Substack：<a href="https://wwhowbuhow.substack.com/" target="_blank" rel="noopener">連結</a></li>
            <li>Paragraph：<a href="https://paragraph.com/@wwhowbuhow" target="_blank" rel="noopener">連結</a></li>
          </ul>
        </div>
      `;
      const list = await renderNewsletterList('/data/newsletter/newsletter_1', '#newsletter');
      return head + list;
    }
    
    // Newsletter 第二份電子報頁面
    async function pageNewsletter2() {
      const head = `
        <h1>Newsletter｜《區塊鏈文摘》</h1>
        <div class="card">
          <ul>
            <li>Substack：<a href="https://taiweb3.substack.com/" target="_blank" rel="noopener">連結</a></li>
            <li>Paragraph：<a href="https://paragraph.com/@tw3" target="_blank" rel="noopener">連結</a></li>
          </ul>
        </div>
      `;
      const list = await renderNewsletterList('/data/newsletter/newsletter_2', '#newsletter2');
      return head + list;
    }

    /* ========================================
     * 靜態頁面內容
     * ======================================== */
    
    const staticPages = {
      home: `
        <h1>Welcome to GCAKE.Space</h1>
        <p>個人品牌與創作空間，聚焦 Podcast、電子報與研究作品。</p>
        <div class="grid">
          <div class="card">
            <h3>Podcast</h3>
            <p><a href="#podcast">《喂喂你還好不好》</a></p>
            <p><a href="#podcast2">《雞蛋糕孵蛋中》</a></p>
          </div>
          <div class="card">
            <h3>Newsletter</h3>
            <p><a href="#newsletter">喂喂你還好不好</a></p>
            <p><a href="#newsletter2">區塊鏈文摘</a></p>
          </div>
        </div>
      `,
      works: `
        <h1>Works & Resources</h1>
        <div class="card">
          <h3>Taiwan Podcaster 龐大資訊人包</h3>
          <p><a href="https://sites.google.com/view/taiwanpodcast/" target="_blank" rel="noopener">入口 1</a> ｜ <a href="https://sites.google.com/view/taiwanpodcast/%E9%A6%96%E9%A0%81?authuser=0" target="_blank" rel="noopener">入口 2</a></p>
        </div>
      `,
      about: `
        <h1>About</h1>
        <img src="img/gcake_pod.png" alt="Avatar" class="avatar">
        <p>現役躁鬱症患者，有一個 podcast 、兩份電子報。</p>
        <p>運動科學（運動生物力學）研究員、區塊鏈推廣者。</p>
        <p>台灣最大免費 Podcast 製作教學網站內容編輯。</p>
        <p>邀約聯絡：<a href="mailto:wwhowbuhow@pm.me">wwhowbuhow@pm.me</a></p>
      `,
      contact: `
        <h1>Contact & Support</h1>
        <div class="card">
          <h3>Email</h3>
          <p><a href="mailto:wwhowbuhow@pm.me">wwhowbuhow@pm.me</a></p>
        </div>
        <div class="card">
          <h3>加密貨幣抖內</h3>
          <p><a href="https://gcake119.fkey.id/" target="_blank" rel="noopener">抖內頁</a></p>
          <ul>
            <li>BTC on-chain: bc1qty2qy4vp69w5yecn5m8q56zlu80yz6uh3w9whr</li>
            <li>BTC lightning: <a href="mailto:gcake119@walletofsatoshi.com">gcake119@walletofsatoshi.com</a></li>
            <li>ETH: gcake119.fkey.eth</li>
            <li>ADA handle: $gcake119</li>
            <li>TEZ: gcake119.tez</li>
          </ul>
        </div>
        <div class="card">
          <h3>硬體錢包夥伴</h3>
          <ul>
            <li><a href="https://shop.ledger.com/pages/referral-program?referral_code=NNS6VK4T6YRFP" target="_blank" rel="noopener">Ledger</a></li>
            <li><a href="https://affil.trezor.io/SHh5" target="_blank" rel="noopener">Trezor</a></li>
            <li><a href="https://www.coolwallet.io/products/coolwallet-pro/?ref=zta0ymf" target="_blank" rel="noopener">CoolWallet</a></li>
          </ul>
        </div>
      `
    };

    /* ========================================
     * SPA 路由系統
     * ======================================== */
    
    async function render() {
      // 解析當前 hash 路由
      const [routePart] = location.hash.replace('#','').split('?');
      const hash = routePart || 'home';
      const app = document.getElementById('app');
      
      try {
        // 根據 hash 值渲染對應頁面
        if (hash === 'podcast') {
          app.innerHTML = await pagePodcast1();
        } else if (hash === 'podcast2') {
          app.innerHTML = await pagePodcast2();
        } else if (hash === 'newsletter') {
          app.innerHTML = await pageNewsletter1();
        } else if (hash === 'newsletter2') {
          app.innerHTML = await pageNewsletter2();
        } else if (hash === 'viewPodcast') {
          // Podcast 單集詳情頁面
          const q = params();
          if (!q.dir || !q.slug) {
            app.innerHTML = `<div class="card"><p>缺少參數。</p></div>`;
          } else {
            app.innerHTML = await renderPodcastDetail(q.dir, q.slug);
          }
        } else if (hash === 'viewNewsletter') {
          // Newsletter 單篇詳情頁面
          const q = params();
          if (!q.dir || !q.slug) {
            app.innerHTML = `<div class="card"><p>缺少參數。</p></div>`;
          } else {
            app.innerHTML = await renderNewsletterDetail(q.dir, q.slug);
          }
        } else {
          // 靜態頁面
          app.innerHTML = staticPages[hash] || staticPages.home;
        }
      } catch (e) {
        // 錯誤處理
        console.error('渲染錯誤:', e);
        app.innerHTML = `<div class="card"><p>載入失敗：${htmlEscape(String(e.message || e))}</p></div>`;
      }
    }
    
    /* ========================================
     * 初始化與事件監聽
     * ======================================== */
    
    // 監聽 hash 變化，實現 SPA 路由
    window.addEventListener('hashchange', render);
    
    // 頁面載入完成後進行初始渲染
    render();
  </script>
</body>
</html>
